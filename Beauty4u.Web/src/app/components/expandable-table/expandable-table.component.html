<!-- Expand/Collapse All Button -->
<div class="mb-4 flex justify-end">
    <button mat-stroked-button color="primary" (click)="toggleAll()" *ngIf="tableGroups.length > 0">
        {{ allExpanded() ? 'Collapse All' : 'Expand All' }}
    </button>
</div>

<!-- Table Groups -->
<div *ngFor="let group of tableGroups; let i = index">
    <mat-card class="mb-4 compact-card">
        <mat-card-header>
            <mat-card-title class="flex justify-between items-center w-full text-sm font-semibold">
                <span>
                    {{ group.tableName }}
                    <span class="text-muted ml-2 font-normal">
                        (Total: {{ getTotalRowCount(i) }}, Invalid: {{ getInvalidRowCount(i) }})
                    </span>
                </span>

                <div class="flex gap-2 items-center">
                    <mat-form-field appearance="outline" floatLabel="auto" class="search-box compact-search">
                        <mat-label>Search</mat-label>
                        <input matInput [(ngModel)]="filters()[i]" (ngModelChange)="applyFilter(i)" />
                    </mat-form-field>
                    <button mat-icon-button (click)="toggleGroup(i)" matTooltip="Expand or collapse group">
                        <mat-icon>{{ expandedGroups()[i] ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </button>
                </div>
            </mat-card-title>
        </mat-card-header>

        <mat-card-content *ngIf="expandedGroups()[i]">
            <div class="table-wrapper compact-table-wrapper">
                <table mat-table [dataSource]="getPagedRows(i)" class="mat-elevation-z2 compact-table auto-fit-table"
                    [style.table-layout]="'auto'">
                    <!-- Columns -->
                    <ng-container *ngFor="let column of group.columns" [matColumnDef]="column.fieldName">
                        <th mat-header-cell *matHeaderCellDef sticky
                            class="compact-header font-bold bg-gray-100 sticky top-0 z-20 text-sm">
                            {{ column.header }}
                        </th>

                        <td mat-cell *matCellDef="let row" class="auto-cell px-2 py-1 align-top">
                            <ng-container *ngIf="row.cells[column.fieldName] as cell">
                                <ng-container [ngSwitch]="typeof cell.rawValue">
                                    <!-- Boolean -->
                                    <ng-container *ngSwitchCase="'boolean'">
                                        <mat-icon class="status-icon"
                                            [ngClass]="[cell.rawValue ? 'icon-true' : 'icon-false', cell.cssClass]"
                                            [matTooltip]="cell.tooltip || ''" matTooltipPosition="above"
                                            matTooltipClass="tooltip-follow" [matTooltipShowDelay]="200"
                                            [matTooltipTouchGestures]="'auto'">
                                            {{ cell.rawValue ? 'check_circle' : 'cancel' }}
                                        </mat-icon>
                                    </ng-container>

                                    <!-- Text -->
                                    <ng-container *ngSwitchDefault>
                                        <span class="compact-text" [ngClass]="cell.cssClass"
                                            [matTooltip]="cell.tooltip || ''" matTooltipPosition="above"
                                            matTooltipClass="tooltip-follow" [matTooltipShowDelay]="200"
                                            [matTooltipTouchGestures]="'auto'">
                                            <mat-icon *ngIf="cell.cssIcon" class="inline-icon mr-1">
                                                {{ cell.cssIcon }}
                                            </mat-icon>
                                            {{ cell.textValue }}
                                        </span>
                                    </ng-container>
                                </ng-container>
                            </ng-container>
                        </td>
                    </ng-container>

                    <!-- Header & Row -->
                    <tr mat-header-row *matHeaderRowDef="getDisplayedColumns(group)" class="sticky top-0 z-10 bg-white">
                    </tr>
                    <tr mat-row *matRowDef="let row; columns: getDisplayedColumns(group)" [ngClass]="row.cssClass"
                        [matTooltip]="row.tooltip" matTooltipPosition="above" matTooltipClass="tooltip-follow"></tr>
                </table>

                <!-- Empty Message -->
                <div class="empty-message py-3 text-center text-gray-500" *ngIf="getPagedRows(i).length === 0">
                    No matching records found.
                </div>

                <!-- Pagination -->
                <mat-paginator [length]="getFilteredData(i).length" [pageSize]="pageSizes()[i]"
                    [pageIndex]="pageIndexes()[i]" [pageSizeOptions]="[5, 10, 25, 50]" (page)="onPage($event, i)">
                </mat-paginator>
            </div>
        </mat-card-content>
    </mat-card>
</div>