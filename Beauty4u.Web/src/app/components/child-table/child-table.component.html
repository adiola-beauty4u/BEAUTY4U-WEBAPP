<mat-card class="mb-4 compact-card">
    <mat-card-content>

        <!-- Header with Table Name, Counts, and Search -->
        <div class="flex flex-wrap items-center justify-between w-full text-sm font-semibold mb-2">
            <span class="truncate">
                {{ group.tableName }}
                <span class="text-gray-500 ml-2 font-normal">
                    (Total: {{ getTotalRowCount() }}
                    <ng-container *ngIf="showInvalidCount">, Invalid: {{ getInvalidRowCount() }}</ng-container>)
                </span>
            </span>

            <mat-form-field appearance="outline" class="w-56 m-0 p-0">
                <mat-label>Search</mat-label>
                <input matInput [(ngModel)]="searchText" (ngModelChange)="applySearch()" placeholder="Filter..." />
            </mat-form-field>
            <button mat-icon-button (click)="toggleTable()" matTooltip="Expand or collapse group">
                <mat-icon>{{ hideTable ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
        </div>

        <!-- Table Wrapper with Scrollbars -->
        <div class="table-wrapper compact-table-wrapper border rounded-md overflow-auto max-h-[400px]"
            *ngIf="!hideTable">
            <table mat-table [dataSource]="pagedData" matSort (matSortChange)="sortData($event)"
                class="mat-elevation-z1 compact-table auto-fit-table min-w-full" [style.table-layout]="'auto'">

                <ng-container *ngIf="enableRowSelection" matColumnDef="select">
                    <th mat-header-cell *matHeaderCellDef sticky
                        class="compact-header bg-gray-100 sticky top-0 z-20 text-xs font-bold uppercase px-2 py-1 border-b">
                        <mat-checkbox (change)="$event ? toggleAllRows() : null" [checked]="isAllSelected()"
                            [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()">
                        </mat-checkbox>
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-2 py-1 border-b">
                        <mat-checkbox (click)="$event.stopPropagation()"
                            (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)"
                            [aria-label]="checkboxLabel(row)">
                        </mat-checkbox>
                    </td>
                </ng-container>

                <ng-container *ngIf="enableRowDelete" matColumnDef="rowDelete">
                    <th mat-header-cell *matHeaderCellDef sticky
                        class="compact-header bg-gray-100 sticky top-0 z-20 text-xs font-bold uppercase px-2 py-1 border-b">
                        Actions
                    </th>
                    <td mat-cell *matCellDef="let row" class="px-2 py-1 border-b text-center">
                        <button mat-icon-button color="warn" matTooltip="Delete Row"
                            (click)="onDeleteRow(row); $event.stopPropagation()">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <ng-container *ngFor="let column of group.columns" [matColumnDef]="column.fieldName">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="{{ column.fieldName }}" sticky
                        class="compact-header bg-gray-100 sticky top-0 z-20 text-xs font-bold uppercase px-2 py-1 border-b">
                        {{ column.header }}
                    </th>

                    <td mat-cell *matCellDef="let row" class="px-2 py-1 align-top text-xs border-b"
                        [ngClass]="row.cells[column.fieldName]?.cssClass">
                        <ng-container *ngIf="row.cells[column.fieldName] as cell">
                            <button *ngIf="column.isCommand" mat-stroked-button color="primary" type="button"
                                [matTooltip]="cell.tooltip || ''"
                                (click)="methodList[column.commandName] && methodList[column.commandName](cell.commandParameter)">
                                {{ cell.textValue || column.header }}
                            </button>
                            <span *ngIf="!column.isCommand" class="compact-text" [matTooltip]="cell.tooltip || ''">
                                <mat-icon *ngIf="cell.cssIcon" class="inline-icon mr-1 text-sm">{{ cell.cssIcon
                                    }}</mat-icon>
                                {{ cell.textValue }}
                            </span>
                        </ng-container>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: tableColumns" [ngClass]="row.cssClass"
                    [matTooltip]="row.tooltip" matTooltipPosition="above" matTooltipClass="tooltip-follow">
                </tr>
            </table>


            <!-- Empty State -->
            <div class="py-2 text-center text-gray-500 text-sm" *ngIf="filteredData.length === 0">
                No matching records found.
            </div>
        </div>

        <!-- Paginator -->
        <mat-paginator [length]="filteredData.length" [pageSize]="pageSize" [pageIndex]="pageIndex"
            [pageSizeOptions]="[5, 10, 25, 50]" (page)="onPageChange($event)">
        </mat-paginator>

    </mat-card-content>
</mat-card>